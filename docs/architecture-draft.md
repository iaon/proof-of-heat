# Proof-of-Heat: архитектурный набросок

## Цели и ориентиры
- Комфортная температура с минимальной стоимостью: управление тепловой мощностью майнеров и других источников с учётом тарифов и эффективности.
- Расширяемость: новые типы устройств (майнеры, котлы, насосы, датчики, шлюзы «умного дома») подключаются плагинами без правок ядра.
- Прозрачность: веб-интерфейс с состоянием системы, графиками и управлением режимами, боты и уведомления.
- Надёжность: контроллер работает автономно, выдерживает офлайн режимы, сохраняет историю и конфигурацию.

## Технический стек (Python)
- **API/веб**: FastAPI (легковесно, OpenAPI, WebSocket), Jinja2/HTMX для простого встроенного UI или отдельный фронтенд (React/Vite) при необходимости.
- **Фоновые задачи**: APScheduler/RQ для расписаний, периодических опросов и управления профилями.
- **Данные и модели**: Pydantic/SQLModel для схем конфигурации и DTO.
- **Интероп/шина**: MQTT-клиент (paho-mqtt) для интеграции с умным домом и публикации телеметрии.
- **Уведомления/боты**: Aiogram/Telegram, optional: Matrix/Slack/SMS email gateways.

## Архитектура подсистем
- **Core Control Engine**
  - Управление целевой температурой/тепловой мощностью по входным данным сенсоров и расписаний.
  - Алгоритмы: PID/модель «отопительной кривой» + ограничения по мощности/тарифам.
- **Device/Integration Plugin Layer**
  - Контракты: `DeviceDriver` (управление), `SensorProvider`, `Notifier`, `SmartHomeBridge`.
  - Механизм загрузки: entry points (`importlib.metadata.entry_points`) или каталог плагинов с декларациями зависимостей.
  - Общее API: async-интерфейсы, idempotent команды, health-check, кэширование capabilities.
- **Data Plane**
  - Коллектор телеметрии → очередь/шина → хранилище временных рядов + кэш горячих значений.
  - Event bus (например, `asyncio.Queue` или Redis Streams) для декуплинга UI/ботов/уведомлений от драйверов.
- **Web/UX Layer**
  - UI: состояние устройств, режимы, отопительная кривая, графики температур/мощности.
  - WebSocket/SSE для потоковых обновлений.
  - Bot/notification gateway использует тот же API/шину событий.

## Временные ряды: варианты хранения
- **TimescaleDB (PostgreSQL extension)** — удобно для агрегаций, downsampling, retention; подходит, если нужен SQL и joins с конфигурацией.
- **InfluxDB/QuestDB/TDengine** — специализированные TSDB, если нагрузки высоки.
- **SQLite + Parquet (DuckDB/Polars для аналитики)** — лёгкий локальный вариант для edge-установок; фоновые задачи делают компактизацию и downsampling.
- **Буфер в памяти/Redis** для горячих значений (последние метки) и кэширования трендов в UI.
- Рекомендация: начать с PostgreSQL + Timescale (универсальность, резервное копирование), предусмотреть абстракцию `TimeSeriesRepository` с backend-адаптерами.

## Конфигурация
- **Декларативные файлы** (YAML/TOML) в Git для устройств, кривых отопления, расписаний; парсинг Pydantic-моделями.
- **Runtime-профили** (например, ручной режим, эко, антизамерзание) хранятся в БД (PostgreSQL/SQLite) и могут переключаться через API/ботов.
- **Секреты** — через env/внешние секрет-хранилища; в файлы не попадают.
- Версионирование: checksum конфигурации, миграции через Alembic/SQLModel migrations.

## Авторизация и доступ
- FastAPI + OAuth2/JWT (обновляемые refresh-токены) + роль «админ/оператор/гость».
- Локальные учётки + опциональный OAuth (Home Assistant, GitHub/Google) для удобства.
- Тонкая гранулярность: доступ к устройствам/группам, разрешения на запись.
- Поддержка bot-token access с ограниченными правами.

## Интеграции/плагины
- **Майнеры**: драйверы для популярных API (Antminer, Whatsminer, NiceHash, HiveOS); unified capability «heat_setpoint/power_limit». 
- **Котлы/насосы/датчики**: Modbus RTU/TCP, Zigbee2MQTT/ble, REST-адаптеры.
- **Умный дом**: плагины к Tuya, Home Assistant, Алиса/Яндекс УД, MQTT topics bridge; маршрутизация событий через общую шину.
- **Уведомления**: Telegram/Matrix/email/SMS; политики триггеров (температура ниже X, неисправность драйвера, переход профиля).

## Расписания и режимы
- APScheduler + Pydantic-схемы расписаний (календарь, будни/выходные, тарифные окна).
- Профили: комфорт/эко/отъезд; приоритет тарифа, пределы мощности и шумовые ограничения.
- Правила: ночной режим снижает мощность майнеров, датчики окна → пауза отопления, ручной Override с TTL.

## Наблюдаемость и поддержка
- Логирование: структурные логи (JSON) + кореляционные id действий.
- Метрики Prometheus (uvicorn/gunicorn + кастомные) и алерты.
- Health-check плагинов и watchdog-и (перезапуск опросов, дебаунс команд).

## Минимальная MVP-сборка
1. FastAPI + SQLite/Timescale + APScheduler.
2. Абстракции устройств + один плагин майнера (mock или Antminer) и один сенсор (mock/MQTT).
3. Простая web-страница (HTMX/Alpine) с текущими показаниями и ручным управлением, WebSocket обновления.
4. Telegram-бот: получение статуса, переключение профиля, уведомления.
5. TimeSeriesRepository (SQL/Parquet) + график температуры/мощности.
6. Миграции и YAML-конфиг для устройств/профилей.

## Идеи для будущего
- ML-подбор отопительной кривой и прогноза потребления.
- Автоматический поиск оптимальной мощности майнеров по тарифам/ценам на крипто.
- Геозоны (отключение/понижение при отъезде) и интеграция с календарями.
- UI-редактор расписаний и отопительной кривой.
